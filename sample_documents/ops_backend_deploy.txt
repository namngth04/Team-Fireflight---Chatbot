# Quy trình deploy backend dịch vụ Chatbot

## Bối cảnh
- Áp dụng cho môi trường staging và production.
- Công cụ: GitHub Actions, Docker, Kubernetes namespace `chatbot`.

## Chuẩn bị
1. Đảm bảo nhánh `main` đã được QA approve.
2. Kiểm tra file `.env` đã cập nhật biến `SPOON_AGENT_ENABLED=true`.
3. Chạy `scripts/run_backend_simple.ps1 -NoMcp` để test smoke local.
4. Đảm bảo ChromaDB và Postgres đã migrate tới revision mới nhất (`alembic upgrade head`).
5. Tải hai file mẫu trong `sample_documents/` lên hệ thống để xác nhận ingest hoạt động.

## Các bước triển khai
1. Trigger workflow “Deploy Chatbot Backend”.
2. GitHub Actions build image `registry.local/chatbot-backend:<tag>`.
3. Helm chart `charts/chatbot` được apply với giá trị `image.tag=<tag>`.
4. Sau khi Helm apply xong, script `post-deploy` tự động chạy migration và warm-up Spoon graph bằng cách ping `GET /healthz`.
5. DevOps xác nhận metric `chatbot_response_latency` dưới 1.5s trên Grafana dashboard.

## Hậu kiểm
- Đợi pod `chatbot-backend` chuyển sang trạng thái `Running`.
- Gọi API `POST /api/chat/{conversation_id}` để test message mẫu.
- Kiểm tra log `provider_used` đã trả `spoon-policy` hoặc `spoon-ops`.
- Mở giao diện chatbot, đặt câu hỏi “có được nghỉ thứ 7 không?” để đảm bảo metadata.answer_mode = `llm-summary`.
- Nếu gặp lỗi `snippet-fallback`, kiểm tra biến `SPOON_LLM_PROVIDER_CHAIN` và key Gemini.

## Rollback
1. Chạy `helm rollback chatbot-backend <release> --revision <n-1>`.
2. Khôi phục cấu hình `.env` từ Secret trước đó và chạy lại script warm-up.
3. Thông báo cho kênh `#chatbot-runtime` về thời gian rollback để QA xác nhận.

## Troubleshooting nhanh
- `ImagePullBackOff`: kiểm tra quyền truy cập registry và biến `CI_REGISTRY_PASSWORD`.
- `Gemini provider not registered`: restart pod sau khi cập nhật biến `GEMINI_MODEL`/`SPOON_LLM_PROVIDER_CHAIN`.
- `MCP server 404 /sse`: đảm bảo container `mcp-server` đang chạy với cổng 8001, kiểm tra ingress rule.

## Kênh hỗ trợ
- DevOps on-call: devops@example.com
- Slack: `#chatbot-runtime`


